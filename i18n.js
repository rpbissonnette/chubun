const translations = {
  en: {
    title: "Mandarin Pronunciation Trainer",
    tone1: "First Tone",
    tone2: "Second Tone",
    tone3: "Third Tone",
    tone4: "Fourth Tone",
    labials: "Labials",
    alveolars: "Alveolars",
    velars: "Velars",
    selectSyllable: "Select a syllable",
    selectSyllableDesc: "Choose a syllable to practice",
    playReference: "Play Reference",
    record: "Record",
    pitchAnalysis: "Pitch Analysis",
    reference: "Reference",
    yourRecording: "Your Recording",
    progress: "Progress",
    syllablesPracticed: "Syllables Practiced:",
    recordingQuality: "Recording Quality:",
    toneAccuracy: "Tone Accuracy:",
    debugReady: "Debug: Ready to start...",
    feedback: {
      overallGood: "Good attempt!",
      pitchLow: "Try to speak with a slightly higher pitch.",
      pitchHigh: "Try to lower your pitch slightly.",
      pitchGood: "Your pitch level is good!",
      toneExcellent:
        "Excellent tone contour! Your pronunciation matches the target tone very well.",
      toneGood:
        "Good tone contour. With a bit more practice, you'll have it perfect.",
      toneNeedsWork:
        "The tone contour needs some work. Listen to the reference audio again.",
      overallExcellent: "Excellent pronunciation! ðŸŽ‰",
      overallGoodProgress: "Good pronunciation! Keep practicing. ðŸ‘",
      overallNeedsWork: "Keep practicing! Focus on the tone pattern.",
      suggestionPitchLow: "Practice speaking from your chest rather than your throat.",
      suggestionPitchHigh: "Relax your vocal cords and speak more naturally.",
      suggestionTone: "Try humming the tone pattern first, then add the syllable.",
      suggestionClarity: "Speak a bit louder and more clearly.",
      suggestionArticulation: "Try to articulate more clearly.",
    },
  },
  zh: {
    title: "æ™®é€šè¯å‘éŸ³æ•™ç»ƒ",
    tone1: "ç¬¬ä¸€å£°",
    tone2: "ç¬¬äºŒå£°",
    tone3: "ç¬¬ä¸‰å£°",
    tone4: "ç¬¬å››å£°",
    labials: "å”‡éŸ³",
    alveolars: "èˆŒå°–éŸ³",
    velars: "èˆŒæ ¹éŸ³",
    selectSyllable: "è¯·é€‰æ‹©éŸ³èŠ‚",
    selectSyllableDesc: "é€‰æ‹©ä¸€ä¸ªéŸ³èŠ‚è¿›è¡Œç»ƒä¹ ",
    playReference: "æ’­æ”¾å‚è€ƒ",
    record: "å½•éŸ³",
    pitchAnalysis: "éŸ³é«˜åˆ†æž",
    reference: "å‚è€ƒ",
    yourRecording: "ä½ çš„å½•éŸ³",
    progress: "ç»ƒä¹ è¿›åº¦",
    syllablesPracticed: "å·²ç»ƒä¹ éŸ³èŠ‚:",
    recordingQuality: "å½•éŸ³è´¨é‡:",
    toneAccuracy: "å£°è°ƒå‡†ç¡®åº¦:",
    debugReady: "è°ƒè¯•: å‡†å¤‡å¼€å§‹...",
    feedback: {
      overallGood: "ä¸é”™çš„å°è¯•ï¼",
      pitchLow: "è¯·è¯•ç€ç¨å¾®æé«˜ä¸€ç‚¹éŸ³é«˜ã€‚",
      pitchHigh: "è¯·è¯•ç€ç¨å¾®é™ä½Žä¸€ç‚¹éŸ³é«˜ã€‚",
      pitchGood: "ä½ çš„éŸ³é«˜æ°´å¹³å¾ˆå¥½ï¼",
      toneExcellent: "å£°è°ƒæ›²çº¿éžå¸¸æ£’ï¼ä½ çš„å‘éŸ³ä¸Žç›®æ ‡å£°è°ƒéžå¸¸åŒ¹é…ã€‚",
      toneGood: "å£°è°ƒæ›²çº¿ä¸é”™ã€‚å†ç¨åŠ ç»ƒä¹ ï¼Œä½ ä¼šæ›´å®Œç¾Žã€‚",
      toneNeedsWork: "å£°è°ƒæ›²çº¿éœ€è¦ä¸€äº›ç»ƒä¹ ã€‚è¯·å†å¬ä¸€éå‚è€ƒéŸ³é¢‘ã€‚",
      overallExcellent: "å‘éŸ³éžå¸¸æ£’ï¼ðŸŽ‰",
      overallGoodProgress: "å‘éŸ³ä¸é”™ï¼ç»§ç»­ç»ƒä¹ ã€‚ðŸ‘",
      overallNeedsWork: "ç»§ç»­ç»ƒä¹ ï¼ä¸“æ³¨äºŽå£°è°ƒæ¨¡å¼ã€‚",
      suggestionPitchLow: "ç»ƒä¹ ä»Žèƒ¸è…”å‘å£°ï¼Œè€Œä¸æ˜¯å–‰å’™ã€‚",
      suggestionPitchHigh: "æ”¾æ¾å£°å¸¦ï¼Œæ›´è‡ªç„¶åœ°è¯´è¯ã€‚",
      suggestionTone: "å…ˆè¯•ç€å“¼å‡ºå£°è°ƒï¼Œç„¶åŽå†å¿µå‡ºéŸ³èŠ‚ã€‚",
      suggestionClarity: "è¯·è¯´å¾—æ›´å¤§å£°ã€æ›´æ¸…æ™°ä¸€äº›ã€‚",
      suggestionArticulation: "è¯·å°è¯•æ›´æ¸…æ™°åœ°å‘éŸ³ã€‚",
    },
  },
  ja: {
    title: "åŒ—äº¬èªžç™ºéŸ³ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼",
    tone1: "ç¬¬ä¸€å£°",
    tone2: "ç¬¬äºŒå£°",
    tone3: "ç¬¬ä¸‰å£°",
    tone4: "ç¬¬å››å£°",
    labials: "å”‡éŸ³",
    alveolars: "æ­¯èŒŽéŸ³",
    velars: "è»Ÿå£è“‹éŸ³",
    selectSyllable: "éŸ³ç¯€ã‚’é¸æŠžã—ã¦ãã ã•ã„",
    selectSyllableDesc: "ç·´ç¿’ã™ã‚‹éŸ³ç¯€ã‚’é¸æŠž",
    playReference: "å‚ç…§éŸ³å£°ã‚’å†ç”Ÿ",
    record: "éŒ²éŸ³",
    pitchAnalysis: "ãƒ”ãƒƒãƒåˆ†æž",
    reference: "å‚ç…§",
    yourRecording: "ã‚ãªãŸã®éŒ²éŸ³",
    progress: "é€²æ—",
    syllablesPracticed: "ç·´ç¿’ã—ãŸéŸ³ç¯€:",
    recordingQuality: "éŒ²éŸ³å“è³ª:",
    toneAccuracy: "å£°èª¿ã®æ­£ç¢ºã•:",
    debugReady: "ãƒ‡ãƒãƒƒã‚°: é–‹å§‹æº–å‚™å®Œäº†...",
    feedback: {
      overallGood: "è‰¯ã„è©¦ã¿ã§ã™ï¼",
      pitchLow: "ã‚‚ã†å°‘ã—é«˜ã„ãƒ”ãƒƒãƒã§è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
      pitchHigh: "ã‚‚ã†å°‘ã—ä½Žã„ãƒ”ãƒƒãƒã§è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
      pitchGood: "ãƒ”ãƒƒãƒã®ãƒ¬ãƒ™ãƒ«ã¯è‰¯å¥½ã§ã™ï¼",
      toneExcellent:
        "ç´ æ™´ã‚‰ã—ã„å£°èª¿ã®è¼ªéƒ­ã§ã™ï¼ã‚ãªãŸã®ç™ºéŸ³ã¯ç›®æ¨™ã®ãƒˆãƒ¼ãƒ³ã¨éžå¸¸ã«ã‚ˆãä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚",
      toneGood: "è‰¯ã„å£°èª¿ã®è¼ªéƒ­ã§ã™ã€‚ã‚‚ã†å°‘ã—ç·´ç¿’ã™ã‚Œã°å®Œç’§ã«ãªã‚Šã¾ã™ã€‚",
      toneNeedsWork:
        "å£°èª¿ã®è¼ªéƒ­ã«ã¯ç·´ç¿’ãŒå¿…è¦ã§ã™ã€‚ã‚‚ã†ä¸€åº¦å‚ç…§éŸ³å£°ã‚’èžã„ã¦ãã ã•ã„ã€‚",
      overallExcellent: "ç´ æ™´ã‚‰ã—ã„ç™ºéŸ³ã§ã™ï¼ðŸŽ‰",
      overallGoodProgress: "è‰¯ã„ç™ºéŸ³ã§ã™ï¼ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚ðŸ‘",
      overallNeedsWork: "ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ï¼å£°èª¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é›†ä¸­ã—ã¦ãã ã•ã„ã€‚",
      suggestionPitchLow: "å–‰ã‹ã‚‰ã§ã¯ãªãã€èƒ¸ã‹ã‚‰è©±ã™ã‚ˆã†ã«ç·´ç¿’ã—ã¦ãã ã•ã„ã€‚",
      suggestionPitchHigh: "å£°å¸¯ã‚’ãƒªãƒ©ãƒƒã‚¯ã‚¹ã•ã›ã¦ã€ã‚‚ã£ã¨è‡ªç„¶ã«è©±ã—ã¦ãã ã•ã„ã€‚",
      suggestionTone:
        "æœ€åˆã«ãƒˆãƒ¼ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒãƒŸãƒ³ã‚°ã—ã¦ã‹ã‚‰ã€éŸ³ç¯€ã‚’åŠ ãˆã¦ã¿ã¦ãã ã•ã„ã€‚",
      suggestionClarity: "ã‚‚ã†å°‘ã—å¤§ããªå£°ã§ã¯ã£ãã‚Šã¨è©±ã—ã¦ãã ã•ã„ã€‚",
      suggestionArticulation: "ã‚‚ã£ã¨ã¯ã£ãã‚Šã¨ç™ºéŸ³ã™ã‚‹ã‚ˆï¿½ï¿½ã«ã—ã¦ãã ã•ã„ã€‚",
    },
  },
};

const setLanguage = (language) => {
  document.querySelectorAll("[data-i18n]").forEach((element) => {
    const key = element.getAttribute("data-i18n");
    const translation = key
      .split(".")
      .reduce((obj, k) => (obj ? obj[k] : undefined), translations[language]);
    if (translation) {
      element.textContent = translation;
    }
  });
  document.documentElement.lang = language;
};

document.addEventListener("DOMContentLoaded", () => {
  const langButtons = document.querySelectorAll(".lang-btn");

  const getBestAvailableLanguage = () => {
    const availableLangs = Object.keys(translations);
    // navigator.languages is an array of preferred languages, e.g., ["en-US", "en", "zh-CN"]
    for (const lang of navigator.languages) {
      if (availableLangs.includes(lang)) {
        return lang; // Exact match, e.g., "en"
      }
      // Check for base language match, e.g., "en-US" should match "en"
      const baseLang = lang.split("-")[0];
      if (availableLangs.includes(baseLang)) {
        return baseLang;
      }
    }
    return "en"; // Default to English
  };

  let currentLanguage = getBestAvailableLanguage();

  const getTranslation = (key) => {
    return key
      .split(".")
      .reduce(
        (obj, k) => (obj ? obj[k] : undefined),
        translations[currentLanguage]
      );
  };

  window.getTranslation = getTranslation;

  langButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const language = button.getAttribute("data-lang");
      currentLanguage = language;
      langButtons.forEach((btn) => btn.classList.remove("active"));
      button.classList.add("active");
      setLanguage(language);
    });
  });

  // Set initial language based on browser settings or default to English
  const initialLangNode = document.querySelector(
    `.lang-btn[data-lang="${currentLanguage}"]`
  );
  if (initialLangNode) {
    initialLangNode.classList.add("active");
  }
  setLanguage(currentLanguage);
});
